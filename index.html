<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Fiscal | Cloud</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            /* Palette - Light */
            --primary: #4f46e5;
            --primary-glow: rgba(79, 70, 229, 0.25);
            --bg-body: #f8fafc;
            --bg-surface: #ffffff;
            --bg-subtle: #f1f5f9;
            --border: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --icon-color: #475569;
            --sidebar-width-collapsed: 70px;
            --sidebar-width-expanded: 240px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-float: 0 10px 15px -3px rgba(0, 0, 0, 0.08);

            /* Status Colors */
            --st-pending-bg: #fef2f2;
            --st-pending-txt: #ef4444;
            --st-active-bg: #fffbeb;
            --st-active-txt: #f59e0b;
            --st-done-bg: #f0fdf4;
            --st-done-txt: #22c55e;
            --st-total-bg: #eff6ff;
            --st-total-txt: #3b82f6;

            /* Transitions */
            --ease: cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --primary: #818cf8;
            --primary-glow: rgba(129, 140, 248, 0.25);
            --bg-body: #0f172a;
            --bg-surface: #1e293b;
            --bg-subtle: #334155;
            --border: #2a3441;
            --text-main: #f8fafc;
            --text-muted: #cbd5e1;
            --icon-color: #cbd5e1;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);

            --st-pending-bg: rgba(239, 68, 68, 0.15);
            --st-pending-txt: #ff5454;
            --st-active-bg: rgba(245, 158, 11, 0.15);
            --st-active-txt: #fcd34d;
            --st-done-bg: rgba(34, 197, 94, 0.15);
            --st-done-txt: #86efac;
            --st-total-bg: rgba(59, 130, 246, 0.15);
            --st-total-txt: #93c5fd;
        }

        /* --- Scrollbars --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-body);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
            border: 2px solid var(--bg-body);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* --- Reset & Base --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Plus Jakarta Sans', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
            transition: background-color 0.4s var(--ease), color 0.4s var(--ease);
        }

        .hidden {
            display: none !important;
        }

        .icon {
            width: 20px;
            height: 20px;
            stroke-width: 2;
            fill: none;
            stroke: currentColor;
            display: block;
        }

        button {
            cursor: pointer;
            border: none;
            background: none;
            transition: all 0.2s var(--ease);
            color: var(--text-main);
        }

        [data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        [data-theme="dark"] .glass {
            background: rgba(30, 41, 59, 0.85);
        }

        /* --- Layout: Sidebar & Content --- */
        .app-layout {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: var(--sidebar-width-collapsed);
            background: var(--bg-surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: width 0.4s var(--ease);
            position: relative;
            z-index: 100;
            flex-shrink: 0;
        }

        .sidebar.expanded {
            width: var(--sidebar-width-expanded);
        }

        .sidebar-header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid var(--border);
            padding: 0;
            transition: padding 0.4s;
        }

        .sidebar.expanded .sidebar-header {
            justify-content: flex-start;
            padding: 0 20px;
        }

        .menu-toggle {
            color: var(--text-muted);
            padding: 8px;
            border-radius: 8px;
        }

        .menu-toggle:hover {
            color: var(--primary);
            background: var(--bg-subtle);
        }

        .logo-text {
            display: none;
            font-weight: 700;
            font-size: 1.1rem;
            margin-left: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .sidebar.expanded .logo-text {
            display: block;
            opacity: 1;
        }

        .sidebar-nav {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 16px 10px;
            gap: 8px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            color: var(--text-muted);
            transition: all 0.2s;
            text-decoration: none;
            cursor: pointer;
            height: 48px;
            white-space: nowrap;
        }

        .nav-item:hover {
            background: var(--bg-subtle);
            color: var(--text-main);
        }

        .nav-item.active {
            background: var(--primary-glow);
            color: var(--primary);
        }

        .nav-icon {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
        }

        .nav-label {
            margin-left: 12px;
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.3s;
            pointer-events: none;
        }

        .sidebar.expanded .nav-label {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }

        .sidebar-footer {
            padding: 16px 10px;
            border-top: 1px solid var(--border);
        }

        /* Theme Toggle */
        .theme-item .nav-icon {
            position: relative;
            width: 24px;
            height: 24px;
        }

        .t-icon {
            position: absolute;
            top: 0;
            left: 0;
            width: 24px;
            height: 24px;
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
        }

        .icon-sun {
            opacity: 1;
            transform: rotate(0deg) scale(1);
            color: var(--text-main);
        }

        .icon-moon {
            opacity: 0;
            transform: rotate(90deg) scale(0.5);
            color: var(--text-main);
        }

        [data-theme="dark"] .icon-sun {
            opacity: 0;
            transform: rotate(-90deg) scale(0.5);
        }

        [data-theme="dark"] .icon-moon {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        /* Main Content */
        .content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        header {
            height: 60px;
            padding: 0 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            z-index: 50;
        }

        .page-title {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .main-container {
            flex: 1;
            padding: 24px 32px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: hidden;
            max-width: 1800px;
            width: 100%;
            margin: 0 auto;
        }

        /* KPI Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .stat-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
            height: 80px;
            position: relative;
            overflow: hidden;
            background-clip: padding-box;
        }

        .stat-card:hover {
            background: var(--bg-subtle);
            border-color: var(--primary-glow);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--border);
            transition: background 0.3s;
            display: none;
        }

        /* Removed side bar */

        .sc-pendente .stat-value,
        .sc-pendente .stat-icon-decoration {
            color: var(--st-pending-txt);
        }

        .sc-andamento .stat-value,
        .sc-andamento .stat-icon-decoration {
            color: var(--st-active-txt);
        }

        .sc-finalizado .stat-value,
        .sc-finalizado .stat-icon-decoration {
            color: var(--st-done-txt);
        }

        .sc-todos .stat-value,
        .sc-todos .stat-icon-decoration {
            color: var(--st-total-txt);
        }

        .stat-card.active {
            background: var(--bg-body);
            border-width: 3px;
            box-shadow: none;
        }

        .sc-pendente.active {
            border-color: var(--st-pending-txt);
        }

        .sc-andamento.active {
            border-color: var(--st-active-txt);
        }

        .sc-finalizado.active {
            border-color: var(--st-done-txt);
        }

        .sc-todos.active {
            border-color: var(--st-total-txt);
        }

        .stat-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 4px;
        }

        .stat-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--text-main);
            line-height: 1;
        }

        .stat-icon-decoration {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-body);
            opacity: 1;
        }

        .stat-icon-decoration svg {
            width: 24px;
            height: 24px;
            stroke-width: 2;
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-group {
            position: relative;
            flex: 1;
        }

        .search-group input {
            width: 100%;
            padding: 10px 12px 10px 40px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-surface);
            color: var(--text-main);
            transition: 0.3s;
            box-shadow: var(--shadow);
        }

        .search-group input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
            outline: none;
        }

        .search-icon,
        .clear-icon {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 12px;
            width: 20px;
            height: 20px;
            z-index: 20;
            transition: color 0.2s;
        }

        /* Apenas o ícone de limpar começa invisível */
        .clear-icon {
            display: none;
            cursor: pointer;
            background: transparent;
            color: var(--text-muted);
        }

        /* A lupa deve ser sempre visível e ficar à esquerda */
        .search-icon {
            display: block;
            /* Garante que a lupa apareça */
            left: 12px;
            right: auto;
            /* Anula o right: 12px do bloco anterior */
            pointer-events: none;
        }

        .btn-new,
        .btn-sec,
        .btn-tool {
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: filter 0.2s;
        }

        /* Classe para hover vermelho (Perigo/Limpar) */
        .btn-hover-red:hover {
            background-color: var(--st-pending-txt) !important;
            /* Fundo Vermelho */
            color: #ffffff !important;
            /* Texto Branco */
            border-color: var(--st-pending-txt) !important;
            /* Borda Vermelha (Parece sem borda) */
        }

        /* Garante que o ícone SVG também fique branco */
        .btn-hover-red:hover svg {
            stroke: #ffffff !important;
            color: #ffffff !important;
        }

        .btn-new {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px var(--primary-glow);
        }

        .btn-new:hover {
            filter: brightness(110%);
        }

        .btn-sec {
            border: 1px solid var(--border);
            color: var(--text-main);
            background: var(--bg-surface);
        }

        .btn-sec:hover {
            background: var(--bg-subtle);
        }

        .btn-tool {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 10px;
        }

        .btn-tool:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--bg-subtle);
        }

        .btn-tool.active {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-glow);
        }

        /* Table */
        .table-wrapper {
            background: var(--bg-surface);
            border-radius: 16px;
            border: 1px solid var(--border);
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
            position: relative;
        }

        .table-scroll {
            flex: 1;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
            table-layout: fixed;
        }

        thead {
            background: var(--bg-subtle);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            text-align: left;
            padding: 14px 16px;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        td {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
            color: var(--text-main);
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        tr:hover td {
            background: var(--bg-body);
        }

        .row-check {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        tr.selected td {
            background: var(--primary-glow);
        }

        .btn-icon.del {
            display: none;
        }

        tr.selected .btn-icon.del {
            display: flex;
        }

        .status-dot {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
        }

        .st-pendente {
            background: var(--st-pending-bg);
            color: var(--st-pending-txt);
        }

        .st-andamento {
            background: var(--st-active-bg);
            color: var(--st-active-txt);
        }

        .st-finalizado {
            background: var(--st-done-bg);
            color: var(--st-done-txt);
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .delay-tag {
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }

        .delay-tag.late {
            color: var(--st-pending-txt);
        }

        .action-cell {
            display: flex;
            justify-content: flex-end;
            gap: 4px;
            min-width: 70px;
        }

        .btn-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--icon-color);
        }

        .btn-icon:hover {
            background: var(--bg-subtle);
            color: var(--primary);
        }

        .btn-icon.del:hover {
            background: var(--st-pending-bg);
            color: var(--st-pending-txt);
        }

        .text-red {
            color: var(--st-pending-txt);
            font-weight: 700;
        }

        .drawer-footer-pagination {
            padding: 8px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 16px;
            background: var(--bg-subtle);
            min-height: 48px;
        }

        /* Login & Skeleton */
        #skeleton-loader {
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: var(--bg-body);
            padding: 32px;
        }

        #login-screen {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: var(--bg-body);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            width: 100%;
            max-width: 400px;
            padding: 40px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 24px;
            box-shadow: var(--shadow-float);
            text-align: center;
        }

        .inp-login-group {
            position: relative;
            margin-bottom: 16px;
        }

        .inp-login {
            width: 100%;
            padding: 12px;
            padding-right: 40px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-subtle);
            color: var(--text-main);
        }

        .toggle-pass {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            cursor: pointer;
            width: 20px;
            height: 20px;
        }

        .btn-login {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border-radius: 10px;
            font-weight: 600;
            margin-top: 10px;
        }

        .remember-box {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 20px;
            justify-content: flex-start;
        }

        /* Drawers & Modals */
        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(3px);
            z-index: 99;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .drawer-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 450px;
            background: var(--bg-surface);
            box-shadow: -10px 0 25px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border);
        }

        .drawer.open {
            transform: translateX(0);
        }

        .drawer-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .drawer-title {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .drawer-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .drawer-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: var(--bg-subtle);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .inp {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-surface);
            color: var(--text-main);
        }

        textarea.inp {
            resize: vertical;
            min-height: 80px;
        }

        /* Advanced Filter Modal */
        .adv-filter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-section-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 4px;
        }

        .checkbox-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .cb-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .cb-item input {
            accent-color: var(--primary);
            width: 16px;
            height: 16px;
        }

        .custom-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 300;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .custom-modal-backdrop.active {
            opacity: 1;
        }

        .custom-modal {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            width: 90%;
            max-width: 650px;
            /* <--- MUDEI DE 450px PARA 650px */
            border-radius: 16px;
            box-shadow: var(--shadow-float);
            transform: scale(0.95);
            transition: transform 0.2s;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            /* Duas colunas iguais */
            gap: 16px;
            /* Espaço entre as colunas */
            margin-bottom: 12px;
        }

        .custom-modal-backdrop.active .custom-modal {
            transform: scale(1);
        }

        .cm-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 1.1rem;
            background: var(--bg-subtle);
        }

        .cm-body {
            padding: 24px;
        }

        .cm-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: var(--bg-subtle);
        }

        /* Toasts */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 400;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-left: 4px solid var(--primary);
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-float);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.4s;
            min-width: 320px;
            pointer-events: auto;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            border-left-color: var(--st-done-txt);
        }

        .toast.error {
            border-left-color: var(--st-pending-txt);
        }

        /* --- Menu de Status (Popover) --- */
        .status-popover {
            position: fixed;
            /* Fica fixo na tela sobrepondo outros itens */
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 2000;
            display: none;
            /* Escondido por padrão */
            flex-direction: column;
            min-width: 150px;
            padding: 6px;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-opt {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: background 0.2s;
            color: var(--text-main);
        }

        .status-opt:hover {
            background: var(--bg-subtle);
        }

        .status-opt .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Cores específicas para as bolinhas do menu */
        .opt-pendente .dot {
            background-color: var(--st-pending-txt);
        }

        .opt-andamento .dot {
            background-color: var(--st-active-txt);
        }

        .opt-finalizado .dot {
            background-color: var(--st-done-txt);
        }

        /* Estilo da Janela de Info (Detalhes) */
        .info-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 0.95rem;
            color: var(--text-main);
            font-weight: 500;
        }

        /* Destaque para o campo de Finalizado/Status */
        .info-highlight {
            background: var(--bg-subtle);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-top: 8px;
        }

        /* Aumenta o espaço na direita para o texto não ficar embaixo do X */
        .search-group input {
            padding-right: 40px;
        }


        .clear-icon:hover {
            color: var(--primary);
            /* Feedback visual ao passar o mouse */
        }
    </style>
</head>

<body>

    <div id="skeleton-loader">
        <h2 style="margin-bottom:20px;">Carregando Nexus Fiscal...</h2>
        <div style="height:200px; background: #e2e8f0; border-radius:12px; animation: shimmer 2s infinite;"></div>
    </div>

    <div id="login-screen">
        <div class="login-card">
            <h1 style="margin-bottom:10px; color:var(--primary);">Nexus Fiscal</h1>
            <p style="margin-bottom:30px; color:var(--text-muted);">Acesso ao Sistema</p>
            <form onsubmit="handleLogin(event)">
                <div class="inp-login-group">
                    <input type="email" id="loginEmail" class="inp-login" placeholder="Email" required>
                </div>
                <div class="inp-login-group">
                    <input type="password" id="loginPass" class="inp-login" placeholder="Senha" required>
                    <div class="toggle-pass" onclick="togglePassVis()">
                        <svg class="icon" viewBox="0 0 24 24" id="eyeIconOpen">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <svg class="icon hidden" viewBox="0 0 24 24" id="eyeIconClose">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
                        </svg>
                    </div>
                </div>
                <div class="remember-box">
                    <input type="checkbox" id="rememberMe"
                        style="accent-color:var(--primary); width:16px; height:16px;">
                    <label for="rememberMe" style="cursor:pointer">Lembrar de mim</label>
                </div>
                <div id="loginError" style="color:var(--st-pending-txt); margin-bottom:15px; font-size:0.9rem;"></div>
                <button type="submit" class="btn-login" id="btnLogin">Entrar</button>
            </form>
        </div>
    </div>

    <div id="app-content" class="app-layout hidden">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="menu-toggle" onclick="toggleSidebar()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg>
                </button>
                <span class="logo-text">Nexus Fiscal</span>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" onclick="navTo('home', this)" title="Controle de Retornos">
                    <div class="nav-icon"><svg class="icon" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
                        </svg></div>
                    <span class="nav-label">Retornos</span>
                </a>
                <a href="#" class="nav-item" onclick="navTo('returns', this)" title="Controle de Devoluções">
                    <div class="nav-icon"><svg class="icon" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg></div>
                    <span class="nav-label">Devoluções</span>
                </a>
                <a href="#" class="nav-item" onclick="openConfig()" title="Configurações">
                    <div class="nav-icon"><svg class="icon" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                        </svg></div>
                    <span class="nav-label">Configurações</span>
                </a>
                <a href="#" class="nav-item theme-item" onclick="toggleTheme()" title="Alterar Tema">
                    <div class="nav-icon">
                        <svg class="t-icon icon-sun" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                        </svg>
                        <svg class="t-icon icon-moon" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                        </svg>
                    </div>
                    <span class="nav-label">Tema</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <a href="#" class="nav-item" onclick="App.logout()" title="Sair do Sistema"
                    style="color: var(--st-pending-txt);">
                    <div class="nav-icon"><svg class="icon" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12" />
                        </svg></div>
                    <span class="nav-label">Sair</span>
                </a>
            </div>
        </aside>

        <div class="content-wrapper">
            <header class="glass">
                <div class="page-title" id="pageHeaderTitle">Controle de Retornos</div>
            </header>

            <div class="main-container" id="viewMain">
                <div class="stats-row">
                    <div class="stat-card sc-pendente" onclick="quickFilter('Pendente')">
                        <div class="stat-info">
                            <div class="stat-label">Pendentes</div>
                            <div class="stat-value" id="kpi-pendente">0</div>
                        </div>
                        <div class="stat-icon-decoration"><svg class="icon" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg></div>
                    </div>
                    <div class="stat-card sc-andamento" onclick="quickFilter('Em andamento')">
                        <div class="stat-info">
                            <div class="stat-label">Em Andamento</div>
                            <div class="stat-value" id="kpi-andamento">0</div>
                        </div>
                        <div class="stat-icon-decoration"><svg class="icon" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                            </svg></div>
                    </div>
                    <div class="stat-card sc-finalizado" onclick="quickFilter('Finalizado')">
                        <div class="stat-info">
                            <div class="stat-label">Finalizados</div>
                            <div class="stat-value" id="kpi-finalizado">0</div>
                        </div>
                        <div class="stat-icon-decoration"><svg class="icon" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg></div>
                    </div>
                    <div class="stat-card sc-todos active" onclick="quickFilter('Todos')">
                        <div class="stat-info">
                            <div class="stat-label">Total</div>
                            <div class="stat-value" id="kpi-todos">0</div>
                        </div>
                        <div class="stat-icon-decoration"><svg class="icon" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                            </svg></div>
                    </div>
                </div>

                <div class="action-bar">
                    <div class="search-group">
                        <svg class="search-icon icon" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                        </svg>

                        <input type="text" id="searchInput" placeholder="Buscar por email, endereço ou série..."
                            oninput="handleSearch()">

                        <svg class="clear-icon icon" id="clearSearchBtn" onclick="clearSearch()" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </div>
                    <button class="btn-tool" id="btnAdvFilter" onclick="openAdvFilter()" title="Filtro Avançado">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                        </svg>
                    </button>
                    <button class="btn-tool" onclick="openDownloadModal()" title="Exportar Excel (.xlsx)">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                    </button>
                    <button class="btn-new" onclick="openDrawer()">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                        Novo
                    </button>
                </div>

                <div class="table-wrapper">
                    <div class="table-scroll">
                        <table>
                            <thead id="dynamicHeader"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                        <div id="emptyState"
                            style="display:none; flex-direction:column; align-items:center; padding:40px; color:var(--text-muted);">
                            <h3>Nenhum registro encontrado</h3>
                            <p>Ajuste os filtros ou adicione um novo registro.</p>
                        </div>
                    </div>
                    <div class="drawer-footer-pagination">
                        <span id="pageInfo"
                            style="font-size:0.85rem; color:var(--text-muted); font-weight:600; margin-right:auto;">Carregando...</span>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-tool" id="btnPrev" onclick="changePage(-1)" style="padding:6px;"><svg
                                    class="icon" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M15.75 19.5L8.25 12l7.5-7.5" />
                                </svg></button>
                            <button class="btn-tool" id="btnNext" onclick="changePage(1)" style="padding:6px;"><svg
                                    class="icon" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                                </svg></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="drawer-overlay" id="drawerOverlay" onclick="closeAllDrawers()"></div>

    <div class="drawer" id="mainDrawer">
        <div class="drawer-header">
            <h2 class="drawer-title" id="drawerTitle">Novo Registro</h2>
            <button onclick="closeAllDrawers()"><svg class="icon" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg></button>
        </div>
        <div class="drawer-body">
            <form id="noteForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="f_id">

                <div class="form-group grp-retornos">
                    <label>Título / Identificação</label>
                    <input type="text" id="f_title" class="inp">
                </div>

                <div class="grp-devolucoes hidden">
                    <div class="form-group">
                        <label>Cliente</label>
                        <input type="text" id="f_client" class="inp">
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                        <div class="form-group"><label>Nota de Venda</label><input type="text" id="f_saleNote"
                                class="inp">
                        </div>
                        <div class="form-group"><label>Nota de Devolução</label><input type="text" id="f_returnNote"
                                class="inp"></div>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                    <div class="form-group">
                        <label id="lblDate">Data Email</label>
                        <input type="date" id="f_date" class="inp" required>
                    </div>
                    <div class="form-group"><label>Status</label>
                        <select id="f_status" class="inp">
                            <option value="Pendente">Pendente</option>
                            <option value="Em andamento">Em andamento</option>
                            <option value="Finalizado">Finalizado</option>
                        </select>
                    </div>
                </div>

                <div class="grp-retornos">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                        <div class="form-group"><label>Tipo</label>
                            <select id="f_type" class="inp">
                                <option value="Locação">Locação</option>
                                <option value="Carcaça">Carcaça</option>
                                <option value="Alienação">Alienação</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Ação Doc</label>
                            <select id="f_action_ret" class="inp">
                                <option value="Emissão">Emissão</option>
                                <option value="Validação">Validação</option>
                                <option value="Entrada">Entrada (Lançamento)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group"><label>Local</label>
                        <select id="f_withdrawal" class="inp">
                            <option value="SP">São Paulo (SP)</option>
                            <option value="Fora de SP">Fora de SP</option>
                        </select>
                    </div>
                    <div style="display:grid; grid-template-columns:3fr 2fr; gap:16px;">
                        <div class="form-group"><label>Endereço</label><input type="text" id="f_address" class="inp">
                        </div>
                        <div class="form-group"><label>Série</label><input type="text" id="f_series" class="inp"></div>
                    </div>
                </div>

                <div class="grp-devolucoes hidden">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                        <div class="form-group"><label>Ação</label>
                            <select id="f_action_dev" class="inp">
                                <option value="Emissão">Emissão</option>
                                <option value="Lançamento">Lançamento</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Divergência</label>
                            <select id="f_divergence" class="inp">
                                <option value="Sem divergência">Sem divergência</option>
                                <option value="Validar">Validar</option>
                                <option value="Divergente">Divergente</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group"><label>Observações</label><textarea id="f_obs" class="inp"></textarea></div>
            </form>
        </div>
        <div class="drawer-footer">
            <button class="btn-sec" onclick="closeAllDrawers()">Cancelar</button>
            <button class="btn-new" onclick="document.getElementById('noteForm').requestSubmit()">Salvar</button>
        </div>
    </div>

    <div class="drawer" id="configDrawer">
        <div class="drawer-header">
            <h2 class="drawer-title">Preferências</h2>
            <button onclick="closeAllDrawers()"><svg class="icon" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg></button>
        </div>
        <div class="drawer-body">
            <div
                style="background:linear-gradient(135deg, var(--bg-subtle), var(--bg-surface)); border:1px solid var(--border); padding:16px; border-radius:12px; display:flex; align-items:center; gap:12px; margin-bottom:24px;">
                <div style="width:48px; height:48px; background:var(--primary); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700;"
                    id="pAvatar">U</div>
                <div>
                    <div style="font-weight:700;" id="pName">Olá</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);" id="pEmail">...</div>
                </div>
            </div>
            <div class="form-group"><label>Alerta de Atraso (Dias)</label><input type="number" id="cfg_delay"
                    class="inp" min="1"></div>
            <div class="form-group"><label>Itens por Página</label><select id="cfg_perPage" class="inp">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select></div>
        </div>
        <div class="drawer-footer">
            <button class="btn-new" style="width:100%; justify-content:center;"
                onclick="App.saveConfig()">Salvar</button>
        </div>
    </div>

    <<div class="custom-modal-backdrop" id="filterModal">
        <div class="custom-modal">
            <div class="cm-header">
                <span>Filtro Avançado</span>
                <button onclick="closeFilterModal()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="cm-body">
                <div id="filterDynamicContent"></div>

                <div class="adv-filter-grid"
                    style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border);">
                    <div>
                        <div class="filter-section-title">Período</div>
                        <div class="form-group" style="margin-bottom:8px;">
                            <input type="date" id="adv_dt_start" class="inp" style="padding:6px;">
                        </div>
                        <div class="form-group">
                            <input type="date" id="adv_dt_end" class="inp" style="padding:6px;">
                        </div>
                    </div>
                </div>
            </div>

            <div class="cm-footer">
                <button class="btn-tool btn-hover-red" onclick="clearFilterForm()"
                    style="margin-right: auto; color: var(--st-pending-txt);">
                    <svg class="icon" viewBox="0 0 24 24" style="width:18px; height:18px; margin-right:4px;">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                    </svg>
                    Limpar
                </button>

                <button class="btn-sec" onclick="closeFilterModal()">Cancelar</button>
                <button class="btn-new" onclick="applyAdvFilter()">Aplicar Filtros</button>
            </div>
        </div>
        </div>

        <div class="custom-modal-backdrop" id="downloadModal">
            <div class="custom-modal" style="max-width:400px;">
                <div class="cm-header">Exportar Dados (Excel)</div>
                <div class="cm-body" style="display:flex; flex-direction:column; gap:12px;">
                    <button class="btn-sec" onclick="App.downloadExcel('all')">Baixar Tudo (Filtrado)</button>
                    <button class="btn-sec" onclick="App.downloadExcel('page')">Baixar Página Atual</button>
                    <button class="btn-sec" onclick="App.downloadExcel('selected')">Baixar Selecionados</button>
                </div>
                <div class="cm-footer">
                    <button class="btn-sec" style="width:100%"
                        onclick="document.getElementById('downloadModal').classList.remove('active'); setTimeout(()=>document.getElementById('downloadModal').style.display='none',200);">Fechar</button>
                </div>
            </div>
        </div>

        <div class="custom-modal-backdrop" id="customModal">
            <div class="custom-modal" style="max-width:350px; text-align:center;">
                <div class="cm-body">
                    <h3 id="cmTitle" style="margin-bottom:8px;">Confirmar</h3>
                    <p id="cmDesc" style="color:var(--text-muted);">Mensagem</p>
                </div>
                <div class="cm-footer" style="justify-content:center;">
                    <button class="btn-sec" onclick="App.closeModal()">Cancelar</button>
                    <button class="btn-new" id="cmConfirmBtn"
                        style="background:var(--st-pending-txt);">Confirmar</button>
                </div>
            </div>
        </div>

        <div class="custom-modal-backdrop" id="infoModal">
            <div class="custom-modal" style="width: 100%; max-width: 450px;">
                <div class="cm-header">
                    <span>Detalhes do Registro</span>
                    <button onclick="closeInfoModal()"><svg class="icon" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg></button>
                </div>
                <div class="cm-body" id="infoContent" style="max-height: 70vh; overflow-y: auto;">
                </div>
                <div class="cm-footer">
                    <button class="btn-sec" style="width:100%" onclick="closeInfoModal()">Fechar</button>
                </div>
            </div>
        </div>

        <div class="toast-container" id="toastArea"></div>

        <div id="statusPopover" class="status-popover">
            <div class="status-opt opt-pendente" onclick="App.confirmStatusChange('Pendente')">
                <span class="dot"></span> Pendente
            </div>
            <div class="status-opt opt-andamento" onclick="App.confirmStatusChange('Em andamento')">
                <span class="dot"></span> Em andamento
            </div>
            <div class="status-opt opt-finalizado" onclick="App.confirmStatusChange('Finalizado')">
                <span class="dot"></span> Finalizado
            </div>
        </div>

        <script>
            // --- CONFIG FIREBASE ---
            const firebaseConfig = {
                apiKey: "AIzaSyCUFCsdZMN2eWQRGI1IKajjVcaI7i2f84k",
                authDomain: "notas-aa832.firebaseapp.com",
                projectId: "notas-aa832",
                storageBucket: "notas-aa832.firebasestorage.app",
                messagingSenderId: "1040377213717",
                appId: "1:1040377213717:web:8b5633a403ecf523be2f1c"
            };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            // --- AUTH & SETUP ---
            async function handleLogin(e) {
                e.preventDefault();
                const btn = document.getElementById('btnLogin');
                const err = document.getElementById('loginError');
                const email = document.getElementById('loginEmail').value;
                const pass = document.getElementById('loginPass').value;
                const remember = document.getElementById('rememberMe').checked;

                btn.innerText = 'Entrando...'; btn.disabled = true; err.innerText = '';
                const persistenceMode = remember ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION;

                auth.setPersistence(persistenceMode)
                    .then(() => auth.signInWithEmailAndPassword(email, pass))
                    .catch((error) => {
                        console.error(error);
                        err.innerText = 'Login falhou. Verifique suas credenciais.';
                        btn.innerText = 'Entrar'; btn.disabled = false;
                    });
            }

            function togglePassVis() {
                const inp = document.getElementById('loginPass');
                const open = document.getElementById('eyeIconOpen');
                const close = document.getElementById('eyeIconClose');
                if (inp.type === 'password') {
                    inp.type = 'text'; open.classList.add('hidden'); close.classList.remove('hidden');
                } else {
                    inp.type = 'password'; open.classList.remove('hidden'); close.classList.add('hidden');
                }
            }

            function toggleSidebar() { document.getElementById('sidebar').classList.toggle('expanded'); }

            // --- NAVIGATION CONTROLLER ---
            function navTo(view, el) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                if (el) el.classList.add('active');

                // Reset
                App.filters = { status: [], type: [], action: [], divergence: [], withdrawal: [], search: '', dateStart: null, dateEnd: null };
                App.page = 1;
                document.getElementById('searchInput').value = '';
                document.getElementById('clearSearchBtn').style.display = 'none';

                if (view === 'home') {
                    App.module = 'retornos';
                    document.getElementById('pageHeaderTitle').innerText = 'Controle de Retornos';
                    document.getElementById('searchInput').placeholder = "Buscar por email, endereço ou série...";
                } else if (view === 'returns') {
                    App.module = 'devolucoes';
                    document.getElementById('pageHeaderTitle').innerText = 'Controle de Devoluções';
                    document.getElementById('searchInput').placeholder = "Buscar por cliente, nota venda, devolução...";
                }
                App.render();
            }

            // --- APP CORE ---
            const App = {
                data: [],
                config: { delay: 6, perPage: 10 },
                module: 'retornos', // 'retornos' ou 'devolucoes'
                filters: {
                    status: [],
                    type: [],
                    action: [],
                    divergence: [],
                    withdrawal: [], // <--- ADICIONE ISSO AQUI
                    search: '',
                    dateStart: null,
                    dateEnd: null
                },
                selectedIds: new Set(),
                page: 1,
                editingId: null,
                currentUser: null,

                // Controle do Menu de Status
                activeStatusId: null,

                init() {
                    auth.onAuthStateChanged((user) => {
                        document.getElementById('skeleton-loader').style.display = 'none';
                        if (user) {
                            this.currentUser = user;
                            document.getElementById('login-screen').style.display = 'none';
                            document.getElementById('app-content').classList.remove('hidden');
                            document.getElementById('pEmail').innerText = user.email;
                            this.loadData();
                        } else {
                            document.getElementById('login-screen').style.display = 'flex';
                            document.getElementById('app-content').classList.add('hidden');
                        }
                    });

                    const conf = localStorage.getItem('nexus_config');
                    if (conf) this.config = JSON.parse(conf);
                    document.documentElement.setAttribute('data-theme', localStorage.getItem('nexus_theme') || 'light');

                    document.addEventListener('click', e => {
                        // Fecha o modal de obs
                        if (!e.target.closest('.obs-btn') && !e.target.closest('.popover')) {
                            const pop = document.getElementById('popover');
                            if (pop) pop.style.display = 'none';
                        }

                        // Fecha o menu de status se clicar fora
                        if (!e.target.closest('.status-popover')) {
                            App.closeStatusMenu();
                        }
                    });
                },

                loadData() {
                    db.collection('notes')
                        .where('uid', '==', this.currentUser.uid)
                        .onSnapshot(snap => {
                            this.data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            this.data.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                            this.render();
                        }, err => console.error("Erro Firestore:", err));
                },

                addOrUpdate(item) {
                    item.module = this.module;

                    const prom = this.editingId
                        ? db.collection('notes').doc(this.editingId).update(item)
                        : db.collection('notes').add({ ...item, uid: this.currentUser.uid, createdAt: Date.now() });

                    prom.then(() => {
                        this.showToast(this.editingId ? 'Atualizado!' : 'Criado!', 'success');
                        closeAllDrawers();
                    }).catch(() => this.showToast('Erro ao salvar.', 'error'));
                },

                delete(id) {
                    document.getElementById('customModal').style.display = 'flex';
                    setTimeout(() => document.getElementById('customModal').classList.add('active'), 10);
                    document.getElementById('cmDesc').innerText = 'Deseja excluir permanentemente este registro?';
                    document.getElementById('cmConfirmBtn').onclick = () => {
                        db.collection('notes').doc(id).delete();
                        this.selectedIds.delete(id);
                        this.closeModal();
                        this.showToast('Registro excluído.', 'success');
                    };
                },

                // --- FUNÇÕES DO MENU DE STATUS ---
                openStatusMenu(e, id) {
                    e.stopPropagation(); // Impede fechamento imediato
                    this.activeStatusId = id;

                    const menu = document.getElementById('statusPopover');
                    const rect = e.currentTarget.getBoundingClientRect();

                    // Posiciona logo abaixo do elemento clicado
                    menu.style.top = (rect.bottom + 5) + 'px';
                    menu.style.left = rect.left + 'px';
                    menu.style.display = 'flex';
                },

                confirmStatusChange(newStatus) {
                    if (this.activeStatusId) {
                        db.collection('notes').doc(this.activeStatusId).update({ status: newStatus })
                            .then(() => {
                                this.showToast(`Status alterado para ${newStatus}`, 'success');
                            })
                            .catch(() => this.showToast('Erro ao atualizar status', 'error'));
                    }
                    this.closeStatusMenu();
                },

                closeStatusMenu() {
                    const menu = document.getElementById('statusPopover');
                    if (menu) menu.style.display = 'none';
                    this.activeStatusId = null;
                },
                // ----------------------------------------

                toggleSelect(id) {
                    if (this.selectedIds.has(id)) this.selectedIds.delete(id);
                    else this.selectedIds.add(id);
                    this.render();
                },

                toggleAll(checked) {
                    const currentData = this.getFilteredData();
                    const pageData = currentData.slice((this.page - 1) * this.config.perPage, this.page * this.config.perPage);
                    pageData.forEach(d => {
                        if (checked) this.selectedIds.add(d.id);
                        else this.selectedIds.delete(d.id);
                    });
                    this.render();
                },

                getFilteredData() {
                    return this.data.filter(item => {
                        const itemModule = item.module || 'retornos';
                        if (itemModule !== this.module) return false;

                        const s = this.filters.search.toLowerCase();
                        if (s) {
                            if (this.module === 'retornos') {
                                if (!item.title?.toLowerCase().includes(s) && !item.address?.toLowerCase().includes(s) && !item.series?.toLowerCase().includes(s)) return false;
                            } else {
                                if (!item.client?.toLowerCase().includes(s) && !item.saleNote?.toLowerCase().includes(s) && !item.returnNote?.toLowerCase().includes(s)) return false;
                            }
                        }

                        if (this.filters.status.length > 0 && !this.filters.status.includes(item.status)) return false;
                        if (this.filters.type.length > 0 && !this.filters.type.includes(item.type)) return false;
                        if (this.filters.action.length > 0 && !this.filters.action.includes(item.action)) return false;
                        if (this.filters.divergence.length > 0 && !this.filters.divergence.includes(item.divergence)) return false;
                        if (this.filters.withdrawal && this.filters.withdrawal.length > 0) {
                            // Se o item não tiver 'withdrawal' definido, consideramos falso se o filtro estiver ativo
                            if (!item.withdrawal || !this.filters.withdrawal.includes(item.withdrawal)) return false;
                        }
                        if (this.filters.dateStart || this.filters.dateEnd) {
                            const d = item.date;
                            if (this.filters.dateStart && d < this.filters.dateStart) return false;
                            if (this.filters.dateEnd && d > this.filters.dateEnd) return false;
                        }
                        return true;
                    });
                },

                render() {
                    // 1. Configurar Cabeçalhos
                    const thead = document.getElementById('dynamicHeader');

                    // Configura o HTML do cabeçalho baseado no módulo atual
                    if (this.module === 'retornos') {
                        thead.innerHTML = `
        <tr>
            <th style="width: 40px"><input type="checkbox" id="checkAll" onchange="App.toggleAll(this.checked)" class="row-check"></th>
            <th style="width: 20%">Título / EMAIL</th>
            <th style="width: 100px">Data</th>
            <th style="width: 100px">Tipo</th>
            <th style="width: 100px">Ação</th>
            <th style="width: 15%">Endereço</th>
            <th style="width: 150px">Série</th>
            <th style="width: 130px">Status</th>
            <th style="width: 90px">Dias</th>
            <th style="width: 60px; text-align: center;">INFO</th> <th style="width: 100px; text-align: right;"></th>
        </tr>`;
                    } else {
                        thead.innerHTML = `
        <tr>
            <th style="width: 40px"><input type="checkbox" id="checkAll" onchange="App.toggleAll(this.checked)" class="row-check"></th>
            <th style="width: 20%">Cliente</th>
            <th style="width: 10%">Nota Venda</th>
            <th style="width: 10%">Nota Dev.</th>
            <th style="width: 100px">Recebimento</th>
            <th style="width: 120px">Ação</th>
            <th style="width: 140px">Divergência</th>
            <th style="width: 130px">Status</th>
            <th style="width: 90px">Dias</th>
            <th style="width: 60px; text-align: center;">INFO</th> <th style="width: 100px; text-align: right;"></th>
        </tr>`;
                    }

                    // 2. Calcular KPIs (Indicadores)
                    const moduleData = this.data.filter(d => (d.module || 'retornos') === this.module);
                    const counts = { Pendente: 0, 'Em andamento': 0, Finalizado: 0, Todos: 0 };

                    moduleData.forEach(d => {
                        counts.Todos++;
                        if (counts[d.status] !== undefined) counts[d.status]++;
                    });

                    ['Pendente', 'Em andamento', 'Finalizado', 'Todos'].forEach(k => {
                        const idKey = k === 'Em andamento' ? 'andamento' : k.toLowerCase();
                        document.getElementById(`kpi-${idKey}`).innerText = counts[k];
                    });

                    // Atualiza visual dos cards de KPI
                    document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
                    if (this.filters.status.length === 1) {
                        const s = this.filters.status[0];
                        if (s === 'Pendente') document.querySelector('.sc-pendente').classList.add('active');
                        if (s === 'Em andamento') document.querySelector('.sc-andamento').classList.add('active');
                        if (s === 'Finalizado') document.querySelector('.sc-finalizado').classList.add('active');
                    } else if (this.filters.status.length === 0) {
                        document.querySelector('.sc-todos').classList.add('active');
                    } else {
                        document.getElementById('btnAdvFilter').classList.add('active');
                    }

                    // 3. Filtragem e Paginação
                    const filtered = this.getFilteredData();
                    const start = (this.page - 1) * this.config.perPage;
                    const pageData = filtered.slice(start, start + this.config.perPage);

                    // Limpa a tabela e verifica estado vazio
                    const tbody = document.getElementById('tableBody');
                    tbody.innerHTML = '';
                    document.getElementById('emptyState').style.display = filtered.length ? 'none' : 'flex';

                    // Atualiza checkbox "Selecionar Todos"
                    const allSelected = pageData.length > 0 && pageData.every(d => this.selectedIds.has(d.id));
                    const checkAll = document.getElementById('checkAll');
                    if (checkAll) checkAll.checked = allSelected;

                    // Contagem para destacar Séries duplicadas (Apenas Retornos)
                    const seriesCounts = {};
                    if (this.module === 'retornos') {
                        moduleData.forEach(d => {
                            const s = (d.series || '').trim().toLowerCase();
                            if (s) seriesCounts[s] = (seriesCounts[s] || 0) + 1;
                        });
                    }

                    // 4. Renderizar Linhas
                    pageData.forEach(item => {
                        const days = this.calcDays(item.date);
                        const isLate = days > this.config.delay && item.status !== 'Finalizado';
                        const isSel = this.selectedIds.has(item.id);

                        let stClass = 'st-pendente';
                        if (item.status === 'Em andamento') stClass = 'st-andamento';
                        if (item.status === 'Finalizado') stClass = 'st-finalizado';

                        const tr = document.createElement('tr');
                        if (isSel) tr.classList.add('selected');

                        // --- NOVO BOTÃO DE INFO (Ícone de bolinha com !) ---
                        // Ele chama App.openInfoModal passando o ID do item
                        const infoBtn = `
        <button class="btn-icon" style="margin:0 auto; color: var(--primary);" onclick="App.openInfoModal('${item.id}')" title="Ver Detalhes">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
            </svg>
        </button>`;

                        // Botões de Ação (Editar / Excluir)
                        const actions = `
        <button class="btn-icon" onclick="openEdit('${item.id}')" title="Editar"><svg class="icon" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg></button>
        <button class="btn-icon del" onclick="App.delete('${item.id}')" title="Excluir"><svg class="icon" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg></button>
        `;

                        // Coluna de Status (com bolinha colorida)
                        const statusCell = `<span class="status-dot ${stClass}" onclick="App.openStatusMenu(event, '${item.id}')"><span class="dot"></span>${item.status}</span>`;

                        // Montagem da Linha HTML
                        if (this.module === 'retornos') {
                            const isDup = seriesCounts[(item.series || '').trim().toLowerCase()] > 1;
                            tr.innerHTML = `
            <td><input type="checkbox" class="row-check" onchange="App.toggleSelect('${item.id}')" ${isSel ? 'checked' : ''}></td>
            <td>${item.title || '-'}</td>
            <td>${item.date.split('-').reverse().join('/')}</td>
            <td>${item.type || '-'}</td>
            <td>${item.action || '-'}</td>
            <td title="${item.address}">${item.address || '-'}</td>
            <td class="${isDup ? 'text-red' : ''}">${item.series || '-'}</td>
            <td>${statusCell}</td>
            <td><span class="delay-tag ${isLate ? 'late' : ''}">${days}d</span></td>
            <td style="text-align:center">${infoBtn}</td>
            <td class="action-cell">${actions}</td>
        `;
                        } else {
                            tr.innerHTML = `
            <td><input type="checkbox" class="row-check" onchange="App.toggleSelect('${item.id}')" ${isSel ? 'checked' : ''}></td>
            <td>${item.client || '-'}</td>
            <td>${item.saleNote || '-'}</td>
            <td>${item.returnNote || '-'}</td>
            <td>${item.date.split('-').reverse().join('/')}</td>
            <td>${item.action || '-'}</td>
            <td>${item.divergence || '-'}</td>
            <td>${statusCell}</td>
            <td><span class="delay-tag ${isLate ? 'late' : ''}">${days}d</span></td>
            <td style="text-align:center">${infoBtn}</td>
            <td class="action-cell">${actions}</td>
        `;
                        }
                        tbody.appendChild(tr);
                    });

                    // 5. Atualiza informações do rodapé (paginação)
                    document.getElementById('pageInfo').innerText = filtered.length ? `${start + 1}-${Math.min(start + this.config.perPage, filtered.length)} de ${filtered.length}` : '0 de 0';
                    document.getElementById('btnPrev').disabled = this.page === 1;
                    document.getElementById('btnNext').disabled = (start + this.config.perPage) >= filtered.length;
                },

                calcDays(dateStr) {
                    const d = new Date(dateStr); d.setHours(0, 0, 0, 0);
                    const t = new Date(); t.setHours(0, 0, 0, 0);
                    const diff = Math.ceil((t - d) / (1000 * 60 * 60 * 24));
                    return d > t ? 0 : diff;
                },

                closeModal() {
                    const m = document.getElementById('customModal');
                    m.classList.remove('active');
                    setTimeout(() => m.style.display = 'none', 200);
                },

                showToast(msg, type) {
                    const area = document.getElementById('toastArea');
                    const el = document.createElement('div');
                    el.className = `toast ${type} show`;

                    const successIcon = `
                    <svg style="width:24px; height:24px; color:#22c55e; flex-shrink:0;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>`;

                    const errorIcon = `
                    <svg style="width:24px; height:24px; color:#ef4444; flex-shrink:0;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
                    </svg>`;

                    const icon = type === 'success' ? successIcon : errorIcon;

                    el.innerHTML = `${icon} <span style="font-weight:500">${msg}</span>`;

                    area.appendChild(el);
                    setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 400); }, 3000);
                },

                logout() { auth.signOut(); closeAllDrawers(); },

                saveConfig() {
                    this.config.delay = parseInt(document.getElementById('cfg_delay').value) || 6;
                    this.config.perPage = parseInt(document.getElementById('cfg_perPage').value) || 10;
                    localStorage.setItem('nexus_config', JSON.stringify(this.config));
                    this.showToast('Configurações Salvas', 'success');
                    this.page = 1; this.render(); closeAllDrawers();
                },

                downloadExcel(mode) {
                    let list = [];
                    const allFiltered = this.getFilteredData();

                    if (mode === 'all') {
                        list = allFiltered;
                    } else if (mode === 'page') {
                        const start = (this.page - 1) * this.config.perPage;
                        list = allFiltered.slice(start, start + this.config.perPage);
                    } else if (mode === 'selected') {
                        list = this.data.filter(i => this.selectedIds.has(i.id));
                        if (list.length === 0) { this.showToast("Nenhum item selecionado.", "error"); return; }
                    }

                    let dataForExcel = [];

                    if (this.module === 'retornos') {
                        dataForExcel = list.map(item => ({
                            "Título / Identificação": item.title,
                            "Data": item.date.split('-').reverse().join('/'),
                            "Tipo": item.type,
                            "Ação": item.action,
                            "Local": item.withdrawal,
                            "Endereço": item.address,
                            "Série": item.series,
                            "Status": item.status,
                            "Observações": item.obs || ""
                        }));
                    } else {
                        dataForExcel = list.map(item => ({
                            "Cliente": item.client || "",
                            "Nota Venda": item.saleNote,
                            "Nota Devolução": item.returnNote,
                            "Data Recebimento": item.date.split('-').reverse().join('/'),
                            "Ação": item.action,
                            "Divergência": item.divergence,
                            "Status": item.status,
                            "Observações": item.obs || ""
                        }));
                    }

                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(dataForExcel);
                    XLSX.utils.book_append_sheet(wb, ws, this.module === 'retornos' ? "Retornos" : "Devoluções");
                    XLSX.writeFile(wb, `Nexus_${this.module}_${new Date().toISOString().slice(0, 10)}.xlsx`);

                    document.getElementById('downloadModal').classList.remove('active');
                    setTimeout(() => document.getElementById('downloadModal').style.display = 'none', 200);
                },

                openInfoModal(id) {
                    const item = this.data.find(i => i.id === id);
                    if (!item) return;

                    const m = document.getElementById('infoModal');
                    const content = document.getElementById('infoContent');

                    // Função auxiliar para criar o HTML de cada item
                    const row = (label, val) => `
        <div class="info-item">
            <span class="info-label">${label}</span>
            <span class="info-value">${val || '-'}</span>
        </div>`;

                    let html = '<div class="info-list">';

                    if (this.module === 'retornos') {
                        // 1. Título sozinho lá em cima
                        html += row('Título / Identificação', item.title);

                        // 2. Grid para os itens lado a lado
                        html += `<div class="info-grid">`;

                        // Linha 1 do Grid
                        html += row('Email / Data', item.date.split('-').reverse().join('/'));
                        html += row('Tipo', item.type);

                        // Linha 2 do Grid
                        html += row('Ação Documental', item.action);
                        html += row('Local', item.withdrawal);

                        // Linha 3 do Grid
                        html += row('Endereço', item.address);
                        html += row('Série', item.series);

                        html += `</div>`; // Fecha o Grid

                    } else {
                        // Layout para Devoluções (mantive padrão, mas organizado)
                        html += row('Cliente', item.client);
                        html += `<div class="info-grid">`;
                        html += row('Data Recebimento', item.date.split('-').reverse().join('/'));
                        html += row('Ação', item.action);
                        html += row('Nota de Venda', item.saleNote);
                        html += row('Nota de Devolução', item.returnNote);
                        html += `</div>`;
                        html += row('Divergência', item.divergence);
                    }

                    // --- Status / Finalizado (Igual ao anterior) ---
                    let statusHtml = '';
                    if (item.status === 'Finalizado') {
                        const dateFin = item.finishedAt ? new Date(item.finishedAt).toLocaleDateString('pt-BR') + ' às ' + new Date(item.finishedAt).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'Data não registrada';

                        statusHtml = `
        <div class="info-item info-highlight" style="border-left: 4px solid var(--st-done-txt);">
            <span class="info-label" style="color:var(--st-done-txt)">Finalizado em</span>
            <span class="info-value">${dateFin}</span>
        </div>`;
                    } else {
                        let color = item.status === 'Pendente' ? 'var(--st-pending-txt)' : 'var(--st-active-txt)';
                        statusHtml = `
        <div class="info-item info-highlight" style="border-left: 4px solid ${color};">
            <span class="info-label" style="color:${color}">Status Atual</span>
            <span class="info-value">${item.status}</span>
        </div>`;
                    }
                    html += statusHtml;

                    // --- Observações (Último campo) ---
                    html += `
        <div class="info-item" style="margin-top:12px; border:none;">
            <span class="info-label">Observações</span>
            <span class="info-value" style="white-space: pre-wrap; font-weight:400; background:var(--bg-body); padding:10px; border-radius:6px; display:block;">${item.obs || 'Nenhuma observação.'}</span>
        </div>`;

                    html += '</div>';

                    content.innerHTML = html;
                    m.style.display = 'flex';
                    setTimeout(() => m.classList.add('active'), 10);
                },
            };



            // --- GLOBAL UI HANDLERS ---
            function openDrawer() {
                App.editingId = null;
                document.getElementById('drawerTitle').innerText = 'Novo Registro';
                document.getElementById('noteForm').reset();
                document.getElementById('f_date').valueAsDate = new Date();
                toggleFormFields();
                document.getElementById('drawerOverlay').classList.add('open');
                document.getElementById('mainDrawer').classList.add('open');
            }

            function openEdit(id) {
                const item = App.data.find(i => i.id === id);
                if (!item) return;
                App.editingId = id;
                document.getElementById('drawerTitle').innerText = 'Editar Registro';

                toggleFormFields();

                document.getElementById('f_date').value = item.date;
                document.getElementById('f_status').value = item.status;
                document.getElementById('f_obs').value = item.obs || '';

                if (App.module === 'retornos') {
                    document.getElementById('f_title').value = item.title;
                    document.getElementById('f_type').value = item.type;
                    document.getElementById('f_action_ret').value = item.action;
                    document.getElementById('f_withdrawal').value = item.withdrawal;
                    document.getElementById('f_address').value = item.address;
                    document.getElementById('f_series').value = item.series;
                } else {
                    document.getElementById('f_client').value = item.client || '';
                    document.getElementById('f_saleNote').value = item.saleNote;
                    document.getElementById('f_returnNote').value = item.returnNote;
                    document.getElementById('f_action_dev').value = item.action;
                    document.getElementById('f_divergence').value = item.divergence;
                }

                document.getElementById('drawerOverlay').classList.add('open');
                document.getElementById('mainDrawer').classList.add('open');
            }

            function toggleFormFields() {
                const isRet = App.module === 'retornos';
                document.querySelectorAll('.grp-retornos').forEach(el => el.classList.toggle('hidden', !isRet));
                document.querySelectorAll('.grp-devolucoes').forEach(el => el.classList.toggle('hidden', isRet));
                document.getElementById('lblDate').innerText = isRet ? 'Data Email' : 'Data Recebimento';
            }

            function closeAllDrawers() {
                document.querySelectorAll('.drawer').forEach(d => d.classList.remove('open'));
                document.getElementById('drawerOverlay').classList.remove('open');
                App.closeModal();
            }

            function handleSubmit(e) {
                e.preventDefault();
                const commonData = {
                    date: document.getElementById('f_date').value,
                    status: document.getElementById('f_status').value,
                    obs: document.getElementById('f_obs').value
                };

                if (App.module === 'retornos') {
                    App.addOrUpdate({
                        ...commonData,
                        title: document.getElementById('f_title').value,
                        type: document.getElementById('f_type').value,
                        action: document.getElementById('f_action_ret').value,
                        withdrawal: document.getElementById('f_withdrawal').value,
                        address: document.getElementById('f_address').value,
                        series: document.getElementById('f_series').value
                    });
                } else {
                    App.addOrUpdate({
                        ...commonData,
                        client: document.getElementById('f_client').value,
                        saleNote: document.getElementById('f_saleNote').value,
                        returnNote: document.getElementById('f_returnNote').value,
                        action: document.getElementById('f_action_dev').value,
                        divergence: document.getElementById('f_divergence').value
                    });
                }
            }

            function quickFilter(st) {
                document.getElementById('btnAdvFilter').classList.remove('active');
                App.filters = { ...App.filters, status: st === 'Todos' ? [] : [st] };
                App.page = 1;
                App.render();
            }

            function handleSearch() {
                // 1. Pega os elementos
                const input = document.getElementById('searchInput');
                const clearBtn = document.getElementById('clearSearchBtn');
                const val = input.value;

                // 2. Lógica VISUAL (Executa mesmo se o App/Firebase der erro)
                if (clearBtn) {
                    // Se tem texto, mostra o X (block). Se não, esconde (none).
                    clearBtn.style.display = val.length > 0 ? 'block' : 'none';
                }

                // 3. Lógica do SISTEMA (Filtro da tabela)
                // Verifica se o 'App' foi carregado corretamente antes de tentar filtrar
                if (typeof App !== 'undefined' && App.filters) {
                    App.filters.search = val;
                    App.page = 1;
                    App.render();
                }
            }

            function clearSearch() {
                const input = document.getElementById('searchInput');
                input.value = '';
                input.focus();
                handleSearch(); // Chama a busca novamente para limpar o filtro e esconder o botão
            }

            function toggleTheme() {
                const n = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', n);
                localStorage.setItem('nexus_theme', n);
            }

            function changePage(d) { App.page += d; App.render(); }

            function openConfig() {
                document.getElementById('cfg_delay').value = App.config.delay;
                document.getElementById('cfg_perPage').value = App.config.perPage;
                document.getElementById('drawerOverlay').classList.add('open');
                document.getElementById('configDrawer').classList.add('open');
            }

            function showObs(btn, text) {
                const m = document.getElementById('obsModal');
                const content = document.getElementById('obsContent');
                content.innerHTML = text;
                m.style.display = 'flex';
                setTimeout(() => m.classList.add('active'), 10);
            }
            function closeObsModal() {
                const m = document.getElementById('obsModal');
                m.classList.remove('active');
                setTimeout(() => m.style.display = 'none', 200);
            }

            function openAdvFilter() {
                const m = document.getElementById('filterModal');
                const container = document.getElementById('filterDynamicContent');

                let html = '';

                // --- 1. Bloco Comum (Status) ---
                html += `
    <div class="adv-filter-grid">
        <div>
            <div class="filter-section-title">Status</div>
            <div class="checkbox-list">
                <label class="cb-item"><input type="checkbox" name="f_st" value="Pendente"> Pendente</label>
                <label class="cb-item"><input type="checkbox" name="f_st" value="Em andamento"> Em andamento</label>
                <label class="cb-item"><input type="checkbox" name="f_st" value="Finalizado"> Finalizado</label>
            </div>
        </div>
    `;

                // --- 2. Blocos Específicos por Módulo ---
                if (App.module === 'retornos') {
                    html += `
        <div>
            <div class="filter-section-title">Tipo</div>
            <div class="checkbox-list">
                <label class="cb-item"><input type="checkbox" name="f_tp" value="Locação"> Locação</label>
                <label class="cb-item"><input type="checkbox" name="f_tp" value="Carcaça"> Carcaça</label>
                <label class="cb-item"><input type="checkbox" name="f_tp" value="Alienação"> Alienação</label>
            </div>
        </div>
    </div> <div class="adv-filter-grid">
        <div>
            <div class="filter-section-title">Local</div>
            <div class="checkbox-list">
                <label class="cb-item"><input type="checkbox" name="f_wd" value="SP"> São Paulo (SP)</label>
                <label class="cb-item"><input type="checkbox" name="f_wd" value="Fora de SP"> Fora de SP</label>
            </div>
        </div>

        <div>
            <div class="filter-section-title">Ação Doc</div>
            <div class="checkbox-list">
                <label class="cb-item"><input type="checkbox" name="f_ac" value="Emissão"> Emissão</label>
                <label class="cb-item"><input type="checkbox" name="f_ac" value="Validação"> Validação</label>
                <label class="cb-item"><input type="checkbox" name="f_ac" value="Entrada"> Entrada (Lançamento)</label>
            </div>
        </div>`;
                } else {
                    // Bloco para Devoluções
                    html += `
        <div>
            <div class="filter-section-title">Ação</div>
            <div class="checkbox-list">
                <label class="cb-item"><input type="checkbox" name="f_ac" value="Emissão"> Emissão</label>
                <label class="cb-item"><input type="checkbox" name="f_ac" value="Lançamento"> Lançamento</label>
            </div>
        </div>
    </div> <div class="adv-filter-grid">
        <div>
            <div class="filter-section-title">Divergência</div>
            <div class="checkbox-list">
                <label class="cb-item"><input type="checkbox" name="f_dv" value="Sem divergência"> Sem divergência</label>
                <label class="cb-item"><input type="checkbox" name="f_dv" value="Validar"> Validar</label>
                <label class="cb-item"><input type="checkbox" name="f_dv" value="Divergente"> Divergente</label>
            </div>
        </div>`;
                }

                html += `</div>`; // Fecha grid final
                container.innerHTML = html;

                // Exibe o modal
                m.style.display = 'flex';
                setTimeout(() => m.classList.add('active'), 10);

                // --- 3. Hidratação dos Checkboxes (Recuperar estado atual) ---

                // Status
                if (App.filters.status) {
                    document.querySelectorAll('input[name="f_st"]').forEach(c => c.checked = App.filters.status.includes(c.value));
                }

                // Tipo
                if (App.filters.type) {
                    document.querySelectorAll('input[name="f_tp"]').forEach(c => c.checked = App.filters.type.includes(c.value));
                }

                // Ação
                if (App.filters.action) {
                    document.querySelectorAll('input[name="f_ac"]').forEach(c => c.checked = App.filters.action.includes(c.value));
                }

                // Divergência (Devoluções)
                if (App.filters.divergence) {
                    document.querySelectorAll('input[name="f_dv"]').forEach(c => c.checked = App.filters.divergence.includes(c.value));
                }

                // --- NOVO: Local (Retornos) ---
                if (App.filters.withdrawal) {
                    document.querySelectorAll('input[name="f_wd"]').forEach(c => c.checked = App.filters.withdrawal.includes(c.value));
                }

                // Datas
                document.getElementById('adv_dt_start').value = App.filters.dateStart || '';
                document.getElementById('adv_dt_end').value = App.filters.dateEnd || '';
            }

            function closeFilterModal() {
                const m = document.getElementById('filterModal');
                m.classList.remove('active');
                setTimeout(() => m.style.display = 'none', 200);
            }

            function applyAdvFilter() {
                const st = Array.from(document.querySelectorAll('input[name="f_st"]:checked')).map(c => c.value);
                const tp = Array.from(document.querySelectorAll('input[name="f_tp"]:checked')).map(c => c.value);
                const ac = Array.from(document.querySelectorAll('input[name="f_ac"]:checked')).map(c => c.value);
                const dv = Array.from(document.querySelectorAll('input[name="f_dv"]:checked')).map(c => c.value);

                // Você já tinha essa linha correta:
                const wd = Array.from(document.querySelectorAll('input[name="f_wd"]:checked')).map(c => c.value);

                const ds = document.getElementById('adv_dt_start').value;
                const de = document.getElementById('adv_dt_end').value;

                App.filters = {
                    ...App.filters,
                    status: st,
                    type: tp,
                    action: ac,
                    divergence: dv,
                    withdrawal: wd, // <--- O ERRO ESTAVA AQUI (FALTAVA ESSA LINHA)
                    dateStart: ds || null,
                    dateEnd: de || null
                };

                App.page = 1;
                App.render();
                closeFilterModal();
            }

            function openDownloadModal() {
                const m = document.getElementById('downloadModal');
                m.style.display = 'flex';
                setTimeout(() => m.classList.add('active'), 10);
            }

            App.init();
            function closeInfoModal() {
                const m = document.getElementById('infoModal');
                m.classList.remove('active');
                setTimeout(() => m.style.display = 'none', 200);
            }

            function clearFilterForm() {
                // 1. Desmarca todos os checkboxes dentro do modal de filtro
                const checkboxes = document.querySelectorAll('#filterModal input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);

                // 2. Limpa os campos de data
                document.getElementById('adv_dt_start').value = '';
                document.getElementById('adv_dt_end').value = '';

                // Opcional: Feedback visual rápido
                App.showToast('Filtros limpos (Clique em Aplicar)', 'success');
            }
        </script>
</body>

</html>
